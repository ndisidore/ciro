// Matrix build example: pipeline-level + step-level matrix.
//
// Pipeline-level matrix (platform) is correlated across steps:
//   build[platform=linux/amd64] -> test[platform=linux/amd64], etc.
//
// Step-level matrix (go-version) is independent:
//   Each test step expands into variants per Go version.
//
// Total: 2 build steps + 4 test steps.
//
// Note: cross-arch execution requires QEMU/binfmt support:
//   docker run --privileged --rm tonistiigi/binfmt --install all

pipeline "matrix-ci" {
    matrix {
        platform "linux/amd64" "linux/arm64"
    }

    step "build" {
        image "golang:1.23"
        platform "${matrix.platform}"
        run "echo building for ${matrix.platform} && go version"
    }

    step "test" {
        matrix {
            go-version "1.22" "1.23"
        }
        depends-on "build"
        image "golang:${matrix.go-version}"
        platform "${matrix.platform}"
        run "echo testing on ${matrix.platform} with $(go version)"
    }
}
